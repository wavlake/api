steps:
  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-t', '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/api:latest',
      '--build-arg', 'COMMIT_SHA=latest',
      '.'
    ]
  
  # Push the container image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/api:latest']
  
  # Deploy container image to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args: [
      'run', 'deploy', 'api',
      '--image', '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/api:latest',
      '--region', '${_REGION}',
      '--platform', 'managed',
      '--allow-unauthenticated',
      '--set-env-vars', 'COMMIT_SHA=latest,GOOGLE_CLOUD_PROJECT=$PROJECT_ID,GCS_BUCKET_NAME=wavlake-audio',
      '--update-secrets', 'WEBHOOK_SECRET=webhook-secret:latest,PROD_POSTGRES_CONNECTION_STRING_RO=PROD_POSTGRES_CONNECTION_STRING_RO:latest',
      '--vpc-connector', 'cloud-sql-postgres',
      '--service-account', 'api-service@wavlake-alpha.iam.gserviceaccount.com'
    ]
  
  # TODO: Deploy Cloud Function manually for now due to permission issues
  # gcloud functions deploy process-audio-upload --gen2 --runtime go122 --trigger-bucket wavlake-audio --source ./cloud-function --entry-point ProcessAudioUpload --region us-central1 --set-env-vars API_BASE_URL=https://api-854568123236.us-central1.run.app/v1

substitutions:
  _REGION: us-central1
  _REPOSITORY: api-repo

options:
  logging: CLOUD_LOGGING_ONLY